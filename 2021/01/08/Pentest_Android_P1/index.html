<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Pentest Android (Part1) | Hydrasky</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="TL;TDXin chào  mọi ngơơi, Chúng các bạn 1 năm 2021 vui vẻ và gặp nhiều may mắn. Năm 2021 mình đã có nhiều dự định, mục tiêu mới . Mở đầu năm mới mình sẽ thêm 1 series về Mobile Security.Phần đầu tiên">
<meta property="og:type" content="article">
<meta property="og:title" content="Pentest Android (Part1)">
<meta property="og:url" content="http://blog.hydrasky.ml/2021/01/08/Pentest_Android_P1/index.html">
<meta property="og:site_name" content="Hydrasky">
<meta property="og:description" content="TL;TDXin chào  mọi ngơơi, Chúng các bạn 1 năm 2021 vui vẻ và gặp nhiều may mắn. Năm 2021 mình đã có nhiều dự định, mục tiêu mới . Mở đầu năm mới mình sẽ thêm 1 series về Mobile Security.Phần đầu tiên">
<meta property="og:locale">
<meta property="og:image" content="http://blog.hydrasky.ml/images/Aroid/folder.png">
<meta property="og:image" content="http://blog.hydrasky.ml/images/Aroid/DevelopersFlow.jpg">
<meta property="og:image" content="http://blog.hydrasky.ml/images/Aroid/ReversersFlow.jpg">
<meta property="og:image" content="http://blog.hydrasky.ml/images/Aroid/bytecode-trong-java.png">
<meta property="og:image" content="http://blog.hydrasky.ml/images/Aroid/Machine-Code-and-Bytecode_Figure-2.jpg">
<meta property="og:image" content="http://blog.hydrasky.ml/images/Aroid/runtime.png">
<meta property="og:image" content="http://blog.hydrasky.ml/images/Aroid/artvsdal.png">
<meta property="og:image" content="http://blog.hydrasky.ml/images/Aroid/JavaBytecod1.png">
<meta property="og:image" content="http://blog.hydrasky.ml/images/Aroid/Android-Pentesting-2048x1237.png">
<meta property="article:published_time" content="2021-01-08T05:00:00.000Z">
<meta property="article:modified_time" content="2021-01-08T05:00:00.000Z">
<meta property="article:author" content="Le Binh An">
<meta property="article:tag" content="Pentest Mobile">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.hydrasky.ml/images/Aroid/folder.png">
  
    <link rel="alternate" href="/atom.xml" title="Hydrasky" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hydrasky</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.hydrasky.ml"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Pentest_Android_P1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/08/Pentest_Android_P1/" class="article-date">
  <time datetime="2021-01-08T05:00:00.000Z" itemprop="datePublished">2021-01-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Pentest Android (Part1)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>TL;TD<br>Xin chào  mọi ngơơi, Chúng các bạn 1 năm 2021 vui vẻ và gặp nhiều may mắn. Năm 2021 mình đã có nhiều dự định, mục tiêu mới . Mở đầu năm mới mình sẽ thêm 1 series về Mobile Security.<br>Phần đầu tiên chúng ta sẽ cùng tìm hiểu về  Android app, cụ thể hơn là các kiến thức cơ bản về nó. Dần dần về sau sẽ đi sâu hơn và sang cả IOS nữa. Bắt đầu thôi nào !!! </p>
<p> <h3>Cấu trúc của một file Apk ? </h2></p>
<p> Các ứng dụng Android có định dạng file là APK . APK về cơ bản là một tệp ZIP. (Bạn có thể đổi tên phần mở rộng tệp thành .zip và sử dụng giải nén để mở và xem nội dung của nó.). Để decompress file apk có thể sử dụng công cụ có thể là <a target="_blank" rel="noopener" href="https://bytecodeviewer.com/">Bytecode viewer</a>, công cụ này tích hợp nhiều công cụ chuyên dụng để reverse android như Dexjar , APKTool hay có nhiều plugin bổ trợ và cuối cùng là nó một công cụ mã nguồn mở (Open Source). </p>
<p><img src="/images/Aroid/folder.png" alt="image info"></p>
<p>Khi giải nén ra bạn sẽ thấy được cấu trúc của một file APK, nó bao gồm một số folder chứa nhiều file trong đó có một số thư mục chính cần nhớ :</p>
<ul>
<li>META-INF / : Thư mục này sẽ xuất hiện ở trong file APK đã được kí (sign). Bao gồm danh sách các file bên trong APK và chữ kí của chúng.</li>
<li>lib/: Các file của thư viện gốc (native) cho ứng dụng theo mặc định sẽ nằm ở đây! Trong thư mục lib /, có các thư mục dành riêng cho cpu. Ví dụ: armeabi, mips,</li>
<li>res/: Trong folder này chứa tất cả các tài nguyên của ứng dụng như resouce XML, image … .</li>
<li>assets/ : Cũng là nơi chứa các file, tài nguyên mà ứng dụng có thể cần , các thư viện native bổ sung … , đôi khi có thể chứa file DEX.</li>
<li>AndroidManifest.xml : file này dùng để mô tả tên , phiên bản và nội dung file APK</li>
<li>Classes.dex: Bao gồm mã nguồn được biên dịch (Complie), được lưu dưới dạng DEX bytecode.<h2 id="Dalvik-amp-Smali"><a href="#Dalvik-amp-Smali" class="headerlink" title="Dalvik &amp; Smali"></a>Dalvik &amp; Smali</h2></li>
</ul>
<p>Hầu hết các ứng dụng Android được viết bằng Java (Kotlin cũng được hỗ trợ và tương thích với Java ). Thay vì code Java được chạy trong Máy ảo Java (JVM) như các ứng dụng trên máy tính thì trong Android, Java được biên dịch sang định dạng bytecode (có thể tưởng tượng như là binaryfile nhưng thực chất là 2 cái này khác nhau nha ) được gọi <a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions">Dalvik Executable</a> (DEX). Đối với các phiên bản trước của Android, mã bytecode đã được dịch bởi máy ảo Dalvik. Đối với các phiên bản Android mới hơn thì sử dụng Android Runtime (ART) .</p>
<p><img src="/images/Aroid/DevelopersFlow.jpg" alt="image info"></p>
<p>Nếu các nhà phát triển, viết bằng Java và mã được biên dịch sang DEX bytecode, để reverse app , chúng ta làm theo hướng ngược lại.<br><img src="/images/Aroid/ReversersFlow.jpg" alt="image info"></p>
<p>Smali là ngôn ngữ máy mà con người có thể đọc được. Nếu bạn đã thực hiện reverse engineer hoặc học môn kiến ​​trúc máy tính với mã C/C++ đã biên dịch thì có thể hiểu SMALI cũng tương tự như là Assembly (hợp ngữ).</p>
<p>Ví dụ , code hiển thị HelloWord bằng java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void printHelloWorld() &#123;</span><br><span class="line">	System.out.println(&quot;Hello World&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Smali code sẽ là :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.method public static printHelloWorld()V</span><br><span class="line">	.registers 2</span><br><span class="line">	sget-object v0, Ljava&#x2F;lang&#x2F;System;-&gt;out:Ljava&#x2F;io&#x2F;PrintStream;</span><br><span class="line">	const-string v1, &quot;Hello World&quot;</span><br><span class="line">	invoke-virtual &#123;v0,v1&#125;, Ljava&#x2F;io&#x2F;PrintStream;-&gt;println(Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">	return-void</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure><br>Tìm hiểu về các syntax của smali <a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions">tại đây</a>.</p>
<p> Bây giờ, tìm hiểu về một app được thực thi như thế nào thì đầu tiên, ta quay lại một chút về khái niệm bytecode, để có thể hiểu được một file java được thực thi như thế nào trước.</p>
<p><img src="/images/Aroid/bytecode-trong-java.png" alt="image info"></p>
<p>Khi một chương trình Java được thực thi, các trình biên dịch biên dịch đoạn mã và một Bytecode được tạo ra dưới dạng một file .class. Bytecode được gọi là intermediate code (mã trung gian) nên nó sẽ khác với lại machine code (mã máy) -low-level code. Machine code là  là một tập hợp các lệnh bằng ngôn ngữ máy hoặc hệ nhị phân có thể được thực thi trực tiếp bởi CPU. Trong khi đó bytecode không thể thực thi trực tiếp mà cần phải thông qua một trình thông dịch để chuyển sang mã máy và thực thi. </p>
<p>Nghe có vẻ rất tốn thời gian và tài nguyên? Đúng ! Trong các ngôn ngữ mà mình từng biết thì java là thằng tốn bộ nhớ nhất và hầu như ai cũng biết nhưng bù lại một trong nhưng ưu điểm của java nói riêng các côn ngữ thông dịch nói chung đó chính là hỗ trợ đa nền tảng. Tức có nghĩa là chỉ cần có JVM thì trên hệ điều nào cũng sẽ chạy được trong khi đó các file thực thi được viết bởi c lại phụ thuộc vào kiến trúc của máy tính. Ví dụ như không thể chạy file 64bit trên hệ điều hành vi xử lí 32 bit.</p>
<p>Bytecode là một dạng tập lệnh được thiết kế để thực thi bởi máy ảo java (JVM).JVM chuyển đổi mã bytecode thành mã máy. Do đó máy tính nào có JVM đều có thể thực thi bytecode đó. Nói cách khác, bất kỳ nền tảng nào chứa JVM đều có thể thực thi Java Bytecode - Once Write Run Anywhere.</p>
<p><img src="/images/Aroid/Machine-Code-and-Bytecode_Figure-2.jpg" alt="image info"></p>
<h2 id="Qua-trinh-thuc-thi-ung-dung-Android-Runtime"><a href="#Qua-trinh-thuc-thi-ung-dung-Android-Runtime" class="headerlink" title="Quá trình thực thi ứng dụng - Android Runtime"></a>Quá trình thực thi ứng dụng - Android Runtime</h2><p>Đầu tiên chúng ta cần hiểu môi trường Runtime là gì và cũng cần hiểu cách hoạt động của một số công cụ cơ bản là JVM và Dalvik VM.</p>
<p>Nói một cách dễ hiểu, runtime là một hệ thống, môi trường được sử dụng bởi hệ điều hành, đảm nhiệm việc chuyển đổi mã mà bạn viết bằng ngôn ngữ cấp cao như Java sang mã máy và được CPU/Bộ xử lý đọc hiểu.</p>
<p>Khi chạy Android Java app các class được chuyển đổi thành mã DEX bytecode .  Tiếp đó các file định dạng DEX bytecode sẽ được dịch sang mã máy thông qua ART hoặc Dalvik runtimes. Ở đây DEX bytecode độc ​​lập với kiến ​​trúc thiết bị.</p>
<p><img src="/images/Aroid/runtime.png" alt="image info"></p>
<p>Dalvik là một công cụ biên dịch dựa trên JIT (Just in time). Có nhiều hạn chế khi sử dụng Dalvik do đó từ Android 4.4 (kitkat) ART đã được giới thiệu và từ Android 5.0 (Lollipop), nó đã thay thế hoàn toàn Dalvik. Android 7.0 kết hợp trình biên dịch Just in time (JIT) với Android runtime (ART) giúp không ngừng cải thiện hiệu suất của các ứng dụng Android khi chúng chạy. Đặc điểm nối bật của ART là nó sử dụng trình sử biên dịch AOT (Ahead of time). Ngay thời điểm cài đặt chưa thực thi, ART sẽ biên dịch ứng dụng bằng công cụ dex2oat trên thiết bị. Giải thích thuật ngữ:</p>
<ul>
<li><p>JIT: Là 1 trình biên dịch(compiler), nó dịch dalvik byte-code trong .dex → machine-code với cơ chế theo từng method (tức là theo khối). Bởi vì JIT chỉ biên dịch một phần mã nên nó có dung lượng bộ nhớ nhỏ hơn và sử dụng ít không gian vật lý trên thiết bị hơn nhưng thời gian thực thi sẽ lâu hơn.</p>
</li>
<li><p>AOT: Là 1 trình biên dịch, tên của nó có ý nghĩa là biên dịch trước thời gian ứng dụng được thực thi (Nó được chạy dưới nền). Do đó ART sẽ giúp thực thi nhanh hơn vì không biên dịch nhiều lần như JIT nhưng do tốn thời gian để biên dịch  khi một ứng dụng được cài đặt nên việc cài đặt sẽ lâu hơn và chiếm dung lượng lớn hơn một chút để lưu trữ mã đã biên dịch.</p>
</li>
</ul>
<p><img src="/images/Aroid/artvsdal.png" alt="image info"></p>
<p>Để giải quyết các nhược điểm trên, Android bây giờ ngoài sử dụng Just-in-time (JIT) compilation như Dalvik thì còn sử dụng thêm Ahead-of-time(AOT) compilation và Profile-guided compilation, sự kết hợp giữa các chế độ biên dịch này sẽ giúp ứng dụng Android cải thiện được hiệu suất so với sử dụng Dalvik. Các chế độ biên dịch được cấu hình, kết hợp ra sao tuỳ thuộc vào hãng sản xuất điện thoại Android. Giải thích thuật ngữ:</p>
<ul>
<li>Profile-guided compilation: Nó có chức năng hướng dẫn chạy mã trong quá trình ứng dụng thực thi.</li>
</ul>
<p><img src="/images/Aroid/JavaBytecod1.png" alt="image info"></p>
<p>Để thực thì file, JVM sử dụng 2 cơ chế để làm điều này đó là biên dịch (JIT compliaion ) và thông dịch (interpreted).  </p>
<ul>
<li>Interpreted: Thông dịch, trình thông dịch hoạt động với cơ chế dịch từng dòng trong tệp input rồi thực thi ngay dòng output đó, và rồi lại cứ lặp quá trình dịch với các dòng tiếp theo.</li>
</ul>
<p>Lưu ý biên dịch/thông dịch là những khái niệm không đc xác định rõ ràng về lý thuyết, bởi nếu biên dịch mà chạy ở “realtime” thì cũng được gọi là thông dịch. Chắc sẽ có bạn thắc mắc JIT có ngon hơn Interpreted  ?<a target="_blank" rel="noopener" href="https://stackoverrun.com/vi/q/854569"> click để hiểu :) </a></p>
<p>Kết thúc part 1, sẽ là road map về pentest Android app :</p>
<p><img src="/images/Aroid/Android-Pentesting-2048x1237.png" alt="image info"></p>
<p>Nói chung thì pentest mobile không quá phức tạp (Nhưng ko đồng nghĩa với dễ nha), chỉ là thêm phần reverse engineer và analysis code lúc đầu, còn các phần sau khá giống với pentest web application . Nên chịu khó bỏ thời gian để tìm hiểu và có thể làm quen với mobile app.<br>Sang phần tiếp theo mình sẽ đi riêng về từng mục một.Tài liệu về lỗ hổng, các vấn đề về mobile security thì các bạn có thể đọc <a target="_blank" rel="noopener" href="https://mobile-security.gitbook.io/mobile-security-testing-guide/overview/0x03-overview">ở đây</a></p>
<h2>Tài liệu tham khảo</h2>

<p>[+] <a target="_blank" rel="noopener" href="https://github.com/tsug0d/AndroidMobilePentest101/">https://github.com/tsug0d/AndroidMobilePentest101/</a><br>[+] <a target="_blank" rel="noopener" href="https://ragingrock.com/AndroidAppRE/app_fundamentals.html">https://ragingrock.com/AndroidAppRE/app_fundamentals.html</a><br>[+] <a target="_blank" rel="noopener" href="https://mobile-security.gitbook.io/mobile-security-testing-guide/overview/0x03-overview">https://mobile-security.gitbook.io/mobile-security-testing-guide/overview/0x03-overview</a><br>[+] <a target="_blank" rel="noopener" href="https://viblo.asia/p/tu-android-source-code-den-binary-code-ly-do-ios-nhanh-hon-android-1VgZvPN15Aw">https://viblo.asia/p/tu-android-source-code-den-binary-code-ly-do-ios-nhanh-hon-android-1VgZvPN15Aw</a><br>[+] <a target="_blank" rel="noopener" href="https://blog.softwaroid.com/2020/05/02/android-application-penetration-testing-bug-bounty-checklist/">https://blog.softwaroid.com/2020/05/02/android-application-penetration-testing-bug-bounty-checklist/</a><br>[+] <a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions">https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.hydrasky.ml/2021/01/08/Pentest_Android_P1/" data-id="ckjolgvfp00012fjm2xvy2oxp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pentest-Mobile/" rel="tag">Pentest Mobile</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2020/11/29/OS%20command%20Injection/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Command Injection TIP</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BugBoutyTip/" rel="tag">BugBoutyTip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lab/" rel="tag">Lab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pentest-Mobile/" rel="tag">Pentest Mobile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pentest-Web/" rel="tag">Pentest Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Technology/" rel="tag">Technology</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/BugBoutyTip/" style="font-size: 13.33px;">BugBoutyTip</a> <a href="/tags/CTF/" style="font-size: 10px;">CTF</a> <a href="/tags/Lab/" style="font-size: 10px;">Lab</a> <a href="/tags/Pentest-Mobile/" style="font-size: 10px;">Pentest Mobile</a> <a href="/tags/Pentest-Web/" style="font-size: 16.67px;">Pentest Web</a> <a href="/tags/Technology/" style="font-size: 20px;">Technology</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/08/Pentest_Android_P1/">Pentest Android (Part1)</a>
          </li>
        
          <li>
            <a href="/2020/11/29/OS%20command%20Injection/">Command Injection TIP</a>
          </li>
        
          <li>
            <a href="/2020/11/28/DVWA-Part1/">DVWA (OWASP)</a>
          </li>
        
          <li>
            <a href="/2020/07/23/CORS/">Cross-Origin Resource Sharing</a>
          </li>
        
          <li>
            <a href="/2020/06/15/CROSS%20SIDE%20REQUEST%20FORGERY/">Cross Side Request Forgery</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Le Binh An<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>